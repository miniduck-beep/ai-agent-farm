import os
from crewai import Agent, Task, Crew, Process
from crewai_tools import SerperDevTool, ScrapeWebsiteTool
from langchain_google_genai import ChatGoogleGenerativeAI

def create_research_crew(topic):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã.
    """
    print(f"üöÄ [–°–¢–ê–†–¢] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ç–µ–º—ã: '{topic}'")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Gemini 2.5 Flash (—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    print("ü§ñ [LLM] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini 2.5 Flash...")
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –±–µ–∑ beta API
        llm = ChatGoogleGenerativeAI(
            model="gemini-2.5-flash", 
            temperature=0.7,
            google_api_key=os.getenv("GOOGLE_API_KEY")
        )
        print("‚úÖ [LLM] Gemini 2.5 Flash —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    except Exception as e:
        print(f"‚ùå [LLM] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini 2.5 Flash: {e}")
        print("üîÑ [LLM] –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π –º–æ–¥–µ–ª–∏...")
        try:
            llm = ChatGoogleGenerativeAI(
                model="text-bison-001",
                temperature=0.7,
                google_api_key=os.getenv("GOOGLE_API_KEY")
            )
            print("‚úÖ [LLM] Fallback –º–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        except Exception as e2:
            print(f"‚ùå [LLM] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e2}")
            raise e2

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    print("üîß [TOOLS] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∏—Å–∫–∞...")
    search_tool = SerperDevTool()
    scrape_tool = ScrapeWebsiteTool()
    print("‚úÖ [TOOLS] –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã")

    # –ê–≥–µ–Ω—Ç 1: –°—Ç–∞—Ä—à–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å
    print("üë®‚Äçüî¨ [AGENT] –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è...")
    researcher = Agent(
        role='–°—Ç–∞—Ä—à–∏–π –Ω–∞—É—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫',
        goal=f'–ù–∞–π—Ç–∏ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º—É—é —Å–≤–µ–∂—É—é –∏ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ: {topic}',
        backstory=(
            '–í—ã - –æ–ø—ã—Ç–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤. '
            '–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –∫–æ–ø–∞—Ç—å –≥–ª—É–±–æ–∫–æ, –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –∂–µ–º—á—É–∂–∏–Ω—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ '
            '–æ—Ç–¥–µ–ª—è—Ç—å —Ñ–∞–∫—Ç—ã –æ—Ç —à—É–º–∞.'
        ),
        verbose=True,
        allow_delegation=False,
        tools=[search_tool, scrape_tool],
        llm=llm
    )

    # –ê–≥–µ–Ω—Ç 2: –ü–∏—Å–∞—Ç–µ–ª—å-–∞–Ω–∞–ª–∏—Ç–∏–∫
    print("‚úçÔ∏è [AGENT] –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞-–ø–∏—Å–∞—Ç–µ–ª—è...")
    writer = Agent(
        role='–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å',
        goal=f'–ù–∞–ø–∏—Å–∞—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ç–µ–º–µ: {topic}',
        backstory=(
            '–í—ã - –ø–∏—Å–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π '
            '–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç. –í–∞—à–∞ —Ü–µ–ª—å - —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ª–µ–≥–∫–æ '
            '—á–∏—Ç–∞—Ç—å—Å—è –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.'
        ),
        verbose=True,
        allow_delegation=True,
        llm=llm
    )

    # –ó–∞–¥–∞—á–∞ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è
    print("üìã [TASK] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è...")
    task_research = Task(
        description=(
            f'–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–º—ã "{topic}". '
            '–ù–∞–π–¥–∏ –∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–Ω–¥—ã, –≥–ª–∞–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. '
            '–°–æ–±–µ—Ä–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–º—ã–µ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.'
        ),
        expected_output='–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.',
        agent=researcher
    )

    # –ó–∞–¥–∞—á–∞ –¥–ª—è –ø–∏—Å–∞—Ç–µ–ª—è
    print("üìã [TASK] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–∏—Å–∞—Ç–µ–ª—è...")
    task_write = Task(
        description=(
            '–ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç—á–µ—Ç–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø–∏—à–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç. '
            '–û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –≤–≤–µ–¥–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã (3-5 –ø—É–Ω–∫—Ç–æ–≤), '
            '–¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–µ–∑–∏—Å—É –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º.'
        ),
        expected_output=f'–•–æ—Ä–æ—à–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ç–µ–º–µ {topic}.',
        agent=writer
    )

    # –°–±–æ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥—ã
    print("‚ö° [CREW] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∞–≥–µ–Ω—Ç–æ–≤...")
    crew = Crew(
        agents=[researcher, writer],
        tasks=[task_research, task_write],
        process=Process.sequential
    )

    # –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—Ç—ã
    print("üéØ [START] –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—Ç—ã –∫–æ–º–∞–Ω–¥—ã...")
    print("=" * 60)
    result = crew.kickoff()
    print("=" * 60)
    print("üèÅ [FINISH] –†–∞–±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    return result
